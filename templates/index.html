<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bid Application System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .progress-step {
            position: relative;
        }
        .progress-step.completed {
            color: #28a745;
        }
        .progress-step.active {
            color: #007bff;
        }
        .opportunity-card {
            border-left: 4px solid #007bff;
        }
        .opportunity-card.high-match {
            border-left-color: #28a745;
        }
        .opportunity-card.medium-match {
            border-left-color: #ffc107;
        }
        .opportunity-card.low-match {
            border-left-color: #dc3545;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
        .status-card.clickable { cursor: pointer; }
        /* Toggle indicator styles */
        .details-toggle .chevron { transition: transform 0.2s ease; }
        .details-toggle[aria-expanded="true"] .chevron { transform: rotate(180deg); }
        .opportunity-card.expanded .card-body { background-color: rgba(0,0,0,0.02); }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                AI Bid Application System
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Cards -->
        <div class="row mb-4 align-items-stretch">
            <div class="col-md-4">
                <div class="card status-card h-100 clickable" onclick="openDocumentsModal()">
                    <div class="card-body text-center">
                        <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                        <h5 class="card-title">Documents</h5>
                        <p class="card-text" id="documents-count">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-search fa-2x text-info mb-2"></i>
                        <h5 class="card-title">Opportunities</h5>
                        <p class="card-text" id="opportunities-count">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card status-card h-100 clickable" onclick="openApplicationsModal()">
                    <div class="card-body text-center">
                        <i class="fas fa-file-contract fa-2x text-warning mb-2"></i>
                        <h5 class="card-title">Generated Applications</h5>
                        <p class="card-text" id="applications-count">0</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- Main Content -->
        <div class="row">
            <!-- Left Column - Controls -->
            <div class="col-md-4">
                <!-- Document Upload -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-upload me-2"></i>Upload Documents</h5>
                    </div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="document-file" multiple accept=".pdf,.docx,.doc,.txt,.xlsx,.xls">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload me-2"></i>Upload
                            </button>
                            <div class="form-text mt-2">Documents are processed automatically after upload.</div>
                        </form>
                    </div>
                </div>

                <!-- Search Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-search me-2"></i>Search Opportunities</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="search-keywords" placeholder="e.g., software engineer, RFP, remote">
                            <div class="form-text">Search across jobs, government bids, and remote roles</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Days Back</label>
                            <input type="number" class="form-control" id="days-back" value="7" min="1" max="30">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Opportunities</label>
                            <input type="number" class="form-control" id="max-opportunities" value="50" min="1" max="200">
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="quick-search" checked>
                            <label class="form-check-label" for="quick-search">
                                Quick Search (limit keyword count)
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="run-parallel" checked>
                            <label class="form-check-label" for="run-parallel">
                                Run scrapers in parallel
                            </label>
                        </div>
                        <button class="btn btn-info w-100" onclick="searchOpportunities()">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>

            </div>

            <!-- Right Column - Results -->
            <div class="col-md-8">
                <!-- Opportunities List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center page-header">
                        <h5 class="title mb-0"><i class="fas fa-list me-2"></i>Opportunities</h5>
                        <div class="d-flex gap-2">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary active" id="btn-all-opportunities" onclick="filterOpportunities('all')">All</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-job-opportunities" onclick="filterOpportunities('jobs')">Jobs</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-gov-opportunities" onclick="filterOpportunities('government')">Gov Bids</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-remote-opportunities" onclick="filterOpportunities('remote')">Remote</button>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshOpportunities()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="opportunities-list">
                            <div class="text-center text-muted">
                                <i class="fas fa-search fa-3x mb-3"></i>
                                <p>Search for opportunities to see results here</p>
                            </div>
                        </div>
                    </div>
                </div>

                
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="loading-message">Processing...</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">System Message</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let opportunities = [];
        let applications = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            setupEventListeners();
            fetchApplicationHistory();
            fetchSubmissionHistory();
            updateDocumentsCount();
            // Poll counts periodically for real-time updates
            setInterval(updateApplicationsCount, 5000);
            setInterval(updateDocumentsCount, 5000);
        });

        function setupEventListeners() {
            // File upload form
            document.getElementById('upload-form').addEventListener('submit', handleFileUpload);
            // Auto-upload when files are selected
            const fileInput = document.getElementById('document-file');
            fileInput.addEventListener('change', () => {
                if (fileInput.files && fileInput.files.length > 0) {
                    document.getElementById('upload-form').requestSubmit();
                }
            });
        }

        function renderOpportunities() {
            const container = document.getElementById('opportunities-list');
            if (!opportunities || opportunities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p>No opportunities found. Search for opportunities to see results here.</p>
                    </div>
                `;
                return;
            }
            const html = opportunities.map(opp => {
                const collapseId = `opp-details-${slugify(opp.opportunity_id || opp.title || Math.random().toString(36).slice(2))}`;
                return `
                    <div class="card opportunity-card mb-3 ${opp.is_remote ? 'border-success' : ''}" data-opp-id="${opp.opportunity_id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title mb-1">${opp.title || 'Untitled'}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">${opp.agency || opp.company || 'Unknown'}</h6>
                                    <p class="card-text mb-2">
                                        ${opp.due_date ? '<small class="text-muted"><i class="fas fa-calendar-alt me-1"></i>' + new Date(opp.due_date).toLocaleDateString() + '</small>' : ''}
                                    </p>
                                </div>
                                <button class="btn btn-sm btn-link text-decoration-none details-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}" data-opp-toggle="true">
                                    <span class="me-1">Details</span>
                                    <i class="fas fa-chevron-down chevron" style="transition: transform 0.2s ease;"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between opp-actions mt-1">
                                <button class="btn btn-sm btn-primary" onclick="generateApplication('${opp.opportunity_id}')">Generate Application</button>
                                ${opp.url ? '<a href="' + opp.url + '" target="_blank" class="btn btn-sm btn-outline-secondary">View Details</a>' : ''}
                            </div>
                            <div id="${collapseId}" class="collapse mt-3">
                                <div class="p-2 border rounded bg-light">
                                    ${opp.description ? '<div class="mb-2">' + opp.description + '</div>' : '<div class="mb-2 text-muted">No description available.</div>'}
                                    <div class="small text-muted">
                                        ${opp.location ? '<div><i class="fas fa-map-marker-alt me-1"></i>' + opp.location + '</div>' : ''}
                                        ${opp.type ? '<div><i class="fas fa-tag me-1"></i>' + opp.type + '</div>' : ''}
                                        ${opp.source ? '<div><i class="fas fa-globe me-1"></i>' + opp.source + '</div>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
            initOpportunityToggles();
        }

        async function fetchApplicationHistory() {
            try {
                const res = await fetch('/api/history/applications');
                const data = await res.json();
                renderApplicationHistory(data.applications || []);
            } catch (e) {
                console.error('Failed to load application history', e);
            }
        }

        function renderApplicationHistory(items) {
            const container = document.getElementById('application-history-list');
            if (!container) return;
            if (!items || items.length === 0) {
                container.textContent = 'No applications yet.';
                return;
            }
            container.innerHTML = items.map(item => {
                const dateStr = item.generated_date ? new Date(item.generated_date).toLocaleString() : '';
                const combinedUrl = item.combined_path ? `/${item.combined_path}` : '#';
                const externalUrl = item.view_url || item.opportunity_url || '';
                return `
                    <div class="d-flex justify-content-between align-items-start border rounded p-2 mb-2">
                        <div>
                            <div class="fw-bold">${item.opportunity_title || item.opportunity_id || 'Untitled'}</div>
                            <div class="text-muted small"><i class="fas fa-building me-1"></i>${item.opportunity_agency || ''}</div>
                            <div class="text-muted small"><i class="fas fa-calendar-alt me-1"></i>${dateStr}</div>
                        </div>
                        <div class="ms-2 d-flex gap-2">
                            <a class="btn btn-sm btn-outline-primary" target="_blank" href="${combinedUrl}">
                                <i class="fas fa-file-alt me-1"></i>Open
                            </a>
                            ${externalUrl ? '<a class="btn btn-sm btn-outline-secondary" target="_blank" href="' + externalUrl + '"><i class="fas fa-external-link-alt me-1"></i>View on site</a>' : ''}
                            <button class="btn btn-sm btn-outline-success" onclick="emailApplication('${item.opportunity_id}')">
                                <i class="fas fa-paper-plane me-1"></i>Email Package
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication('${item.folder}', this)">
                                <i class="fas fa-trash-alt" aria-label="Delete" title="Delete"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function fetchSubmissionHistory() {
            try {
                const res = await fetch('/api/history/submissions');
                const data = await res.json();
                renderSubmissionHistory(data.submissions || []);
            } catch (e) {
                console.error('Failed to load submission history', e);
            }
        }

        function renderSubmissionHistory(items) {
            const container = document.getElementById('submission-history-list');
            if (!container) return;
            if (!items || items.length === 0) {
                container.textContent = 'No submissions yet.';
                return;
            }
            container.innerHTML = items.map(s => {
                const dt = s.timestamp ? new Date(s.timestamp).toLocaleString() : '';
                const statusBadge = s.status === 'success' ? 'success' : (s.status === 'error' ? 'danger' : 'secondary');
                const externalUrl = s.view_url || s.opportunity_url || '';
                return `
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-bold">${s.opportunity_title || s.opportunity_id || 'Submission'}</div>
                            <span class="badge bg-${statusBadge}">${s.status || 'unknown'}</span>
                        </div>
                        <div class="text-muted small"><i class="fas fa-clock me-1"></i>${dt}</div>
                        ${s.message ? '<div>' + s.message + '</div>' : ''}
                        ${externalUrl ? '<div class="mt-2"><a class="btn btn-sm btn-outline-secondary" target="_blank" href="' + externalUrl + '"><i class="fas fa-external-link-alt me-1"></i>View posting</a></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                document.getElementById('opportunities-count').textContent = status.opportunities_found;
                // Keep documents count in sync with actual available documents
                updateDocumentsCount();
                // Ensure applications count is accurate in real-time
                updateApplicationsCount();
            } catch (error) {
                console.error('Failed to update status:', error);
            }
        }

        function updateApplicationsCount() {
            // Fetch latest count from server to avoid stale cache
            fetch('/api/history/applications')
                .then(res => res.json())
                .then(data => {
                    const count = (data && (data.total ?? (data.applications?.length || 0))) || 0;
                    const el = document.getElementById('applications-count');
                    if (el) el.textContent = count;
                })
                .catch(() => {
                    // fallback to local cache if available
                    try {
                        document.getElementById('applications-count').textContent = (typeof applications !== 'undefined' ? applications.length : 0);
                    } catch (e) {}
                });
        }

        // New: keep the Documents counter in real-time sync with server
        function updateDocumentsCount() {
            fetch('/api/documents')
                .then(res => res.json())
                .then(data => {
                    const count = Array.isArray(data.documents) ? data.documents.length : 0;
                    const el = document.getElementById('documents-count');
                    if (el) el.textContent = count;
                })
                .catch(err => {
                    console.error('Failed to update documents count', err);
                });
        }

        function updateStep(step, completed) {
            const stepElement = document.getElementById(`step-${step}`);
            if (completed) {
                stepElement.classList.add('completed');
                stepElement.classList.remove('active');
            } else {
                stepElement.classList.add('active');
                stepElement.classList.remove('completed');
            }
        }

        function showLoading(message) {
            document.getElementById('loading-message').textContent = message;
            const modalEl = document.getElementById('loadingModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
            modal.show();
        }

        function hideLoading() {
            const modalEl = document.getElementById('loadingModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
            modal.hide();
        }

        function showToast(message, type = 'info') {
            const toastEl = document.getElementById('toast');
            const toastBody = document.getElementById('toast-message');
            if (!toastEl || !toastBody) return;

            toastBody.textContent = message;
            const headerIcon = toastEl.querySelector('.toast-header i');
            if (headerIcon) {
                headerIcon.className = 'fas fa-info-circle me-2';
                if (type === 'success') headerIcon.classList.add('text-success');
                else if (type === 'error') headerIcon.classList.add('text-danger');
                else headerIcon.classList.add('text-primary');
            }

            const bsToast = bootstrap.Toast.getOrCreateInstance(toastEl);
            bsToast.show();
        }

        function hideToast() {
            const toastEl = document.getElementById('toast');
            if (!toastEl) return;
            try {
                const bsToast = bootstrap.Toast.getInstance(toastEl) || new bootstrap.Toast(toastEl);
                bsToast.hide();
            } catch (e) {
                toastEl.classList.remove('show');
            }
        }

        async function openApplicationsModal() {
            let modalEl = document.getElementById('applicationsModal');
            if (!modalEl) {
                const modalHtml = `
<div class="modal fade" id="applicationsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-file-contract me-2"></i>Generated Applications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="applications-empty" class="text-center text-muted">No applications yet.</div>
        <div id="applications-list" class="mt-2"></div>
        <hr/>
        <h6 class="mb-2">Submission History</h6>
        <div id="submission-history-list-modal" class="text-muted small">No submissions yet.</div>
      </div>
    </div>
  </div>
</div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modalEl = document.getElementById('applicationsModal');
            }

            try {
                const [appsRes, subsRes] = await Promise.all([
                    fetch('/api/history/applications'),
                    fetch('/api/history/submissions')
                ]);
                const [appsData, subsData] = await Promise.all([appsRes.json(), subsRes.json()]);

                const appsList = modalEl.querySelector('#applications-list');
                const appsEmpty = modalEl.querySelector('#applications-empty');
                if (!appsData.applications || appsData.applications.length === 0) {
                    appsEmpty.style.display = 'block';
                    appsList.innerHTML = '';
                } else {
                    appsEmpty.style.display = 'none';
                    appsList.innerHTML = appsData.applications.map(item => {
                        const dateStr = item.generated_date ? new Date(item.generated_date).toLocaleString() : '';
                        const combinedUrl = item.combined_path ? `/${item.combined_path}` : '#';
                        const externalUrl = item.view_url || item.opportunity_url || '';
                        return `
<div class="d-flex justify-content-between align-items-start border rounded p-2 mb-2" data-app-item>
  <div>
    <div class="fw-bold">${item.opportunity_title || item.opportunity_id || 'Untitled'}</div>
    <div class="text-muted"><i class="fas fa-building me-1"></i>${item.opportunity_agency || ''}</div>
    <div class="text-muted"><i class="fas fa-calendar-alt me-1"></i>${dateStr}</div>
  </div>
  <div class="ms-2 d-flex gap-2">
    <a class="btn btn-sm btn-outline-primary" target="_blank" href="${combinedUrl}">
      <i class="fas fa-file-alt me-1"></i>Open
    </a>
    ${externalUrl ? '<a class="btn btn-sm btn-outline-secondary" target="_blank" href="' + externalUrl + '"><i class="fas fa-external-link-alt me-1"></i>View on site</a>' : ''}
    <button class="btn btn-sm btn-outline-success" onclick="emailApplication('${item.opportunity_id}')">
      <i class="fas fa-paper-plane me-1"></i>Email
    </button>
    <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication('${item.folder}', this)">
      <i class="fas fa-trash-alt" aria-label="Delete" title="Delete"></i>
    </button>
  </div>
</div>`;
                    }).join('');
                }

                const subsContainer = modalEl.querySelector('#submission-history-list-modal');
                if (!subsData.submissions || subsData.submissions.length === 0) {
                    subsContainer.innerHTML = '<div class="text-muted small">No submissions yet.</div>';
                } else {
                    subsContainer.innerHTML = subsData.submissions.map(s => {
                        const dt = s.timestamp ? new Date(s.timestamp).toLocaleString() : '';
                        const statusBadge = s.status === 'success' ? 'success' : (s.status === 'error' ? 'danger' : 'secondary');
                        const externalUrl = s.view_url || s.opportunity_url || '';
                        return `
<div class="border rounded p-2 mb-2">
  <div class="d-flex justify-content-between align-items-center">
    <div class="fw-bold">${s.opportunity_title || s.opportunity_id || 'Submission'}</div>
    <span class="badge bg-${statusBadge}">${s.status || 'unknown'}</span>
  </div>
  <div class="text-muted"><i class="fas fa-clock me-1"></i>${dt}</div>
  ${s.message ? '<div>' + s.message + '</div>' : ''}
  ${externalUrl ? '<div class="mt-2"><a class="btn btn-sm btn-outline-secondary" target="_blank" href="' + externalUrl + '"><i class="fas fa-external-link-alt me-1"></i>View posting</a></div>' : ''}
</div>`;
                    }).join('');
                }

                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } catch (e) {
                console.error('Failed to load applications', e);
                showToast('Failed to load applications', 'error');
            }
        }


async function handleFileUpload(event) {
    event.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('document-file');

    if (!fileInput || fileInput.files.length === 0) {
        showToast('Please select files to upload', 'warning');
        return;
    }

    for (const file of fileInput.files) {
        formData.append('file', file);
    }

    showLoading('Uploading documents...');
    try {
        const response = await fetch('/api/documents/upload', { method: 'POST', body: formData });
        const result = await response.json();
        if (!response.ok || result.status === 'error') {
            throw new Error(result.message || `HTTP ${response.status}`);
        }
        let toastMsg = result.message || 'Upload successful';
        if (result.auto_processed) {
            const p = result.processing || {};
            const detail = p.message ? ` ${p.message}` : '';
            toastMsg = (toastMsg + detail).trim();
        }
        showToast(toastMsg, result.status === 'warning' ? 'warning' : 'success');
        if (fileInput) fileInput.value = '';
        updateDocumentsCount();
        updateStatus();
    } catch (err) {
        console.error('Upload error:', err);
        showToast('Upload failed: ' + err.message, 'error');
    } finally {
        hideLoading();
    }
}

// processDocuments removed: documents are auto-processed immediately after upload

async function searchOpportunities() {
    const keywords = document.getElementById('search-keywords')?.value?.trim() || null;
    const daysBack = document.getElementById('days-back')?.value || 7;
    const maxOpportunities = document.getElementById('max-opportunities')?.value || 50;
    const quickSearch = !!document.getElementById('quick-search')?.checked;
    const runParallel = !!document.getElementById('run-parallel')?.checked;

    showLoading('Searching for opportunities...');
    try {
        const res = await fetch('/api/opportunities/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                days_back: parseInt(daysBack),
                max_opportunities: parseInt(maxOpportunities),
                quick_search: Boolean(quickSearch),
                run_parallel: Boolean(runParallel),
                keywords: keywords
            })
        });
        const result = await res.json();
        if (result.status === 'success') {
            showToast(result.message || 'Search complete', 'success');
        } else {
            showToast(result.message || 'Search finished with warnings', result.status === 'error' ? 'error' : 'warning');
        }
    } catch (e) {
        showToast('Search failed: ' + e.message, 'error');
    } finally {
        hideLoading();
        updateStatus();
        refreshOpportunities();
    }
}

async function refreshOpportunities() {
    try {
        const res = await fetch('/api/opportunities');
        const data = await res.json();
        opportunities = data.opportunities || [];
        // Default to show all
        const allBtn = document.getElementById('btn-all-opportunities');
        const jobBtn = document.getElementById('btn-job-opportunities');
        const govBtn = document.getElementById('btn-gov-opportunities');
        const remoteBtn = document.getElementById('btn-remote-opportunities');
        if (allBtn) allBtn.classList.add('active');
        if (jobBtn) jobBtn.classList.remove('active');
        if (govBtn) govBtn.classList.remove('active');
        if (remoteBtn) remoteBtn.classList.remove('active');
        renderOpportunities();
    } catch (e) {
        console.error('Failed to refresh opportunities:', e);
    }
}

// Helper: make safe IDs
function slugify(str) {
    return String(str || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
}

// Initialize collapse toggles: rotate chevron, update text, and highlight expanded card
function initOpportunityToggles() {
    const toggles = document.querySelectorAll('[data-opp-toggle="true"]');
    toggles.forEach(btn => {
        const targetSel = btn.getAttribute('data-bs-target');
        const collapseEl = document.querySelector(targetSel);
        if (!collapseEl) return;
        const card = btn.closest('.opportunity-card');
        const labelSpan = btn.querySelector('span');
        collapseEl.addEventListener('show.bs.collapse', () => {
            if (card) card.classList.add('expanded');
            if (labelSpan) labelSpan.textContent = 'Hide';
        });
        collapseEl.addEventListener('hide.bs.collapse', () => {
            if (card) card.classList.remove('expanded');
            if (labelSpan) labelSpan.textContent = 'Details';
        });
    });
}

function filterOpportunities(type) {
    const allBtn = document.getElementById('btn-all-opportunities');
    const jobBtn = document.getElementById('btn-job-opportunities');
    const govBtn = document.getElementById('btn-gov-opportunities');
    const remoteBtn = document.getElementById('btn-remote-opportunities');
    const activeBtn = document.getElementById(`btn-${type}-opportunities`);

    if (allBtn) allBtn.classList.remove('active');
    if (jobBtn) jobBtn.classList.remove('active');
    if (govBtn) govBtn.classList.remove('active');
    if (remoteBtn) remoteBtn.classList.remove('active');
    if (activeBtn) activeBtn.classList.add('active');

    let filtered = opportunities || [];
    if (type === 'jobs') filtered = filtered.filter(o => o.type === 'job');
    else if (type === 'government') filtered = filtered.filter(o => o.type === 'government');
    else if (type === 'remote') filtered = filtered.filter(o => o.is_remote === true);

    const container = document.getElementById('opportunities-list');
    if (!filtered.length) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>No ${type} opportunities found.</p>
            </div>
        `;
        return;
    }

    const html = filtered.map(opp => {
        const collapseId = `opp-details-${slugify(opp.opportunity_id || opp.title || Math.random().toString(36).slice(2))}`;
        return `
    <div class="card opportunity-card mb-3 ${opp.is_remote ? 'border-success' : ''}" data-opp-id="${opp.opportunity_id}">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="card-title mb-1">${opp.title || 'Untitled'}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${opp.agency || opp.company || 'Unknown'}</h6>
                    <p class="card-text mb-2">
                        ${opp.due_date ? '<small class="text-muted"><i class="fas fa-calendar-alt me-1"></i>' + new Date(opp.due_date).toLocaleDateString() + '</small>' : ''}
                    </p>
                </div>
                <button class="btn btn-sm btn-link text-decoration-none details-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}" data-opp-toggle="true">
                    <span class="me-1">Details</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </button>
            </div>
            <div class="d-flex justify-content-between opp-actions mt-1">
                <button class="btn btn-sm btn-primary" onclick="generateApplication('${opp.opportunity_id}')">Generate Application</button>
                ${opp.url ? '<a href="' + opp.url + '" target="_blank" class="btn btn-sm btn-outline-secondary">View Details</a>' : ''}
            </div>
            <div id="${collapseId}" class="collapse mt-3">
                <div class="p-2 border rounded bg-light">
                    ${opp.description ? '<div class="mb-2">' + opp.description + '</div>' : '<div class="mb-2 text-muted">No description available.</div>'}
                    <div class="small text-muted">
                        ${opp.location ? '<div><i class="fas fa-map-marker-alt me-1"></i>' + opp.location + '</div>' : ''}
                        ${opp.type ? '<div><i class="fas fa-tag me-1"></i>' + opp.type + '</div>' : ''}
                        ${opp.source ? '<div><i class="fas fa-globe me-1"></i>' + opp.source + '</div>' : ''}
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
    `;
}).join('');
    container.innerHTML = html;
    initOpportunityToggles();
}

async function generateApplication(opportunityId) {
    showLoading('Generating application...');
    try {
        const res = await fetch('/api/applications/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ opportunity_id: opportunityId, background: false })
        });
        const result = await res.json();
        if (result.status === 'success') {
            // Immediately terminate loader on success
            hideLoading();
            // Inject visible Email button in the corresponding opportunity card
            try {
                const card = document.querySelector(`[data-opp-id="${opportunityId}"]`);
                const actions = card?.querySelector('.opp-actions');
                const hasEmail = actions?.querySelector('[data-opp-email]');
                if (actions && !hasEmail) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-success';
                    btn.setAttribute('data-opp-email', 'true');
                    btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Email Application';
                    btn.addEventListener('click', () => emailApplication(opportunityId));
                    actions.appendChild(btn);
                }
            } catch (e) { /* no-op */ }
            
            showToast(result.message || 'Application generated', 'success');
            // Update counts/history without blocking UI thread
            setTimeout(() => {
                updateApplicationsCount();
                fetchApplicationHistory();
            }, 0);
        } else {
            hideLoading();
            showToast(result.message || 'Generation failed', 'error');
        }
    } catch (e) {
        hideLoading();
        showToast('Generation failed: ' + e.message, 'error');
    }
}

async function emailApplication(opportunityId) {
    // Build selection UI similar to job_applications.html
    try {
        const docsRes = await fetch('/api/documents');
        const docs = await docsRes.json();
        const docNames = (docs.documents || []).map(d => d.name);

        const selectionHtml = `
            <div class="modal fade" id="emailDocsModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-paperclip me-2"></i>Select attachments</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-2 small text-muted">WIC documents are preselected by keyword automatically ("wic") unless you choose "Only send selected" below.</div>
                            <div id="email-docs-list" class="d-flex flex-column gap-1" style="max-height:260px;overflow:auto;"></div>
                            <div class="mt-2">
                                <label class="form-label small">Extra keyword filters (comma-separated)</label>
                                <input id="email-extra-keywords" class="form-control form-control-sm" placeholder="e.g. wic, company profile" value="wic">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="email-selected-only">
                                <label class="form-check-label small" for="email-selected-only">
                                    Only send the files I select (donâ€™t auto-attach suggested docs)
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button id="email-send-btn" type="button" class="btn btn-success">Send Email</button>
                        </div>
                    </div>
                </div>
            </div>`;

        let modalWrapper = document.getElementById('emailDocsModal');
        if (!modalWrapper) {
            const div = document.createElement('div');
            div.innerHTML = selectionHtml;
            document.body.appendChild(div.firstElementChild);
            modalWrapper = document.getElementById('emailDocsModal');
        }

        const listEl = modalWrapper.querySelector('#email-docs-list');
        listEl.innerHTML = (docNames.length ? docNames.map(n => `
            <label class="form-check small">
                <input class="form-check-input" type="checkbox" value="${n}">
                <span class="form-check-label">${n}</span>
            </label>
        `).join('') : '<div class="text-muted small">No documents found. Upload from the Documents section.</div>');

        const bsModal = new bootstrap.Modal(modalWrapper);
        bsModal.show();

        const sendBtn = modalWrapper.querySelector('#email-send-btn');
        // Avoid stacking multiple handlers
        sendBtn.onclick = null;
        sendBtn.onclick = async () => {
            const checked = Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
            const kwInput = modalWrapper.querySelector('#email-extra-keywords');
            const extraKeywords = kwInput.value.split(',').map(s => s.trim()).filter(Boolean);
            const selectedOnly = modalWrapper.querySelector('#email-selected-only').checked;

            bsModal.hide();
            showLoading('Sending email...');
            try {
                const res = await fetch('/api/applications/email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        opportunity_id: opportunityId,
                        extra_doc_names: checked,
                        extra_doc_keywords: extraKeywords,
                        selected_only: selectedOnly
                    })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('Email sent successfully', 'success');
                } else {
                    showToast(result.message || 'Failed to send email', 'error');
                }
            } catch (e) {
                showToast('Email failed: ' + e.message, 'error');
            } finally {
                hideLoading();
                fetchSubmissionHistory();
            }
        };
    } catch (e) {
        // Fallback: if documents fetch fails, try simple send
        try {
            const res = await fetch('/api/applications/email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ opportunity_id: opportunityId })
            });
            const result = await res.json();
            if (result.status === 'success') {
                showToast('Email sent successfully', 'success');
            } else {
                showToast(result.message || 'Failed to send email', 'error');
            }
        } catch (err) {
            showToast('Email failed: ' + err.message, 'error');
        }
    }
}

async function openDocumentsModal() {
    let modalEl = document.getElementById('documentsModal');
    if (!modalEl) {
        const modalHtml = `
<div class="modal fade" id="documentsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Documents</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="documents-empty" class="text-muted">No documents uploaded yet.</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Name</th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody id="documents-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modalEl = document.getElementById('documentsModal');
    }
    try {
        const res = await fetch('/api/documents');
        const data = await res.json();
        const tbody = modalEl.querySelector('#documents-table-body');
        const empty = modalEl.querySelector('#documents-empty');
        if (!data.documents || data.documents.length === 0) {
            empty.style.display = 'block';
            tbody.innerHTML = '';
        } else {
            empty.style.display = 'none';
            tbody.innerHTML = data.documents.map(d => `
              <tr>
                <td>${d.name}</td>
                <td>
                  <a class="btn btn-sm btn-outline-primary" target="_blank" href="/documents/${encodeURIComponent(d.name)}">
                    <i class="fas fa-download me-1"></i>Open
                  </a>
                </td>
              </tr>
            `).join('');
        }
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    } catch (e) {
        console.error('Failed to load documents', e);
        showToast('Failed to load documents', 'error');
    }
}

async function deleteApplication(folder, btn) {
    if (!folder) return;
    const origBtnHtml = btn ? btn.innerHTML : '';
    if (btn) btn.disabled = true, btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    try {
        const res = await fetch('/api/applications/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folder })
        });
        const result = await res.json();
        if (result.status === 'success') {
            showToast('Application deleted', 'success');
            updateApplicationsCount();
            fetchApplicationHistory();
            // Optimistically remove from modal list
            if (btn) {
                const card = btn.closest('[data-app-item]');
                if (card) card.remove();
            }
        } else {
            showToast(result.message || 'Failed to delete application', 'error');
        }
    } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
    } finally {
        if (btn) btn.disabled = false, btn.innerHTML = origBtnHtml;
    }
}

    </script>
</body>
</html>
